<!DOCTYPE html>
<html>
<head>
<!--<script src="http://cdn.peerjs.com/0.3/peer.js"></script>-->
<script src="peer.min.js"></script>
<script type="text/javascript" src="jquery.min.js"></script>
<style>
    #connected
    {
        color:green
    }
    #refresh{
        color:yellow;
    }
</style>
</head>

<body onload="setTimeout('init();', 100);">
<p id='log'></p>
<div id="comm">
    <div id="connected"></div>
    <div id="peerid"></div>
    <div id="remoteid"></div>
    <form action="javascript:void(0);">
        <input id="videoswitch" type="button" value="Video on/off"/>
        <input placeholder="Message:" id="msg" type="text"/>
        <input  id="sender" type="submit" value="Send"/>
    </form>
    <!--<video id="video" autoplay></video>-->
    <video id="video"></video>
    <div id="receiver"></div>

</div>

<script>
(function () {
    var old = console.log;
    var logger = document.getElementById('log');
    console.log = function (message) {
        if (typeof message == 'object') {
            logger.innerHTML += (JSON && JSON.stringify ? JSON.stringify(message) : message) + '<br />';
        } else {
            logger.innerHTML += message + '<br />';
        }
    }
})();


if (util.supports.data && util.supports.binary) {console.log('OK, this browser supports webrtc'); }
else {console.log('NO, this browser does not support webrtc');}
util.reliable=false;
var mystream;
var mycall;
var rcvtimer=18446744073709551616;
var resetTimer=0;
var timerout;
var conn;

//peerjs
var peer = new Peer(
	{host:'peerserver.cloudapp.net', port:80},
	{key: 'gsixocef254gqfr',
	debug:3,
	config: {'iceServers': [

	{url:'stun:piflyerproxy.cloudapp.net'},
    {url:'turn:piflyerproxy.cloudapp.net:443',
     credential:'youhavetoberealistic',
     username:'ninefingers'
     }
	  ]}
});

peer.on('open',function(id){
	console.log('My peer ID is: ' + id);
	$('#peerid').text(id);
    conn = peer.connect('qwd5lls47d620529');
    timeout=setTimeout(function(){location.reload();},3000)
});

peer.on('close', function() {
    console.log('peer closed');
	peer.destroy();
	// not really ok
	$('#connected').text('false');
	ws.send("Q0");
	location.reload();
});

peer.on('disconnected', function() {
	console.log('disconnected from the signalling server');
	//setInterval(function(){peer.reconnect();}, 3000);
	// not really ok
    $('#connected').text('false');
    ws.send("Q0");
});


peer.on('error', function(err) {
    console.log('Error: ' + err.type);
    // not really ok
    $('#connected').text('false');
    ws.send("Q0");
    location.reload();
});

//conn= = peer.connect('qwd5lls47d620529');
conn.on('open', function() {
    clearTimeout(timeout);
	console.log('connection open');
	$('#remoteid').text(conn.peer);
	$('#connected').text(conn.open);
	ws.send("Q1");
	call();
});

conn.on('data', function(data) {
	//console.log('Received: '+data);
	if(data=="restartCall")
	    restartCall();
	ws.send(data);
	rcvTimer=new Date().getTime();
  	$( "#receiver" ).text(data);
});

conn.on('error',function(err){
    console.log('Error: ' + err.type);
    $('#connected').text(conn.open);
    ws.send("Q0");
    location.reload();
});
conn.on('close', function() {
    console.log('connection closed')
    $('#connected').text(conn.open);
    ws.send("Q0");
    location.reload();
});

function send()
{
  if(conn.open) {
	conn.send($('#msg').val());
	$('#msg').val('');
	}
}

function sendstr(str)
{
  var t=new Date().getTime();
  if(conn.open && t-rcvTimer<5000){
	conn.send(str);
	}
  else{
    $('#connected').text(conn.open);
    location.reload();
  }
}

$( "#sender" ).click(function(){
    send();
});

$( "#videoswitch" ).click(function() {
	$('#receiver').empty();
	console.log('dela');
	if (util.supports.audioVideo) { console.log("I support media"); }
	else {console.log("No media support");}

	var p = navigator.mediaDevices.getUserMedia({ audio: false, video: true });

    p.then(function(mediaStream) {
    mystream=mediaStream;
    /*var video = document.querySelector('#video');
    video.src = window.URL.createObjectURL(mediaStream);
        video.onloadedmetadata = function(e) {
        // Do something with the video here.
        // Call a peer, providing our mediaStream
        var remid=$('#remoteid').text();
        mycall = peer.call(remid,mediaStream);
        console.log(mycall.peer);
        };*/
    var remid=$('#remoteid').text();
    mycall = peer.call(remid,mediaStream);
    console.log(mycall.peer);
    });

    p.catch(function(err) {
     console.log(err.name);
    }); // always check for errors at the end.

});

peer.on('call', function(call) {
  // Answer the call, providing our mediaStream
  console.log('call event fired');
  call.answer();

  call.on('stream', function(stream) {
      // `stream` is the MediaStream of the remote peer.
      // Here you'd add it to an HTML video/canvas element.
      var video = document.querySelector('#video');
      video.srcObject = stream;
    });
    call.on('close',function(){
        console.log('stream closed');
    });
    call.on('error', function(err){
        console.log('Error: ' + err.type);
        location.reload();
    });
});

function restartCall(){
    peer.call(mycall.peer,mystream)
}

function isMediaStreamOpen(){
    return mycall.open
}

//websockets
if ("WebSocket" in window) {
    console.log("WebSocket is supported by your browser.");

    var ws = new WebSocket("ws://localhost:9000/ws/");
    ws.onopen = function() {
        console.log("Connection is opened ...");

    };

    ws.onmessage = function (evt) {
        var msg = evt.data;
        //console.log("Message is received: " + msg);
        if(conn.open){
            sendstr(msg)}
    };

    ws.onclose = function() {
        console.log("Connection is closed ...");
        //setTimeout(function(){location.reload();},2000)
    };

} else {
    console.log("WebSocket not supported by your browser.");
}


function call(){
	var p = navigator.mediaDevices.getUserMedia(
	{
	    audio: false,
	    video:
	    {
	        width: { min: 256, ideal: 320, max: 800 },
            height: { min: 192, ideal: 240, max: 600 },
            frameRate: { min:25, ideal:35, max: 50 }
        }
	});
    p.then(function(mediaStream) {
    mystream=mediaStream;
    var remid=$('#remoteid').text();
    mycall = peer.call(remid,mediaStream);
    console.log(mycall.peer);
    });
    p.catch(function(err) {
     console.log(err.name);
    });
}




</script>
</body>
</html>
